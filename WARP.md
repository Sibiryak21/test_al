# WARP.md

Этот файл содержит рекомендации для WARP (warp.dev) при работе с кодом в этом репозитории.

## Обзор проекта

В репозитории находится небольшое Streamlit-приложение для классификации видов пингвинов с помощью предобученной модели Random Forest на датасете Palmer Penguins. Основная точка входа — файл `penguins_streamlit_cloud.py`, который загружает артефакты модели из pickle-файлов и CSV‑датасет, а затем предоставляет интерактивный интерфейс на русском языке для ввода признаков и визуализации распределений.

Ключевые файлы:
- `penguins_streamlit_cloud.py` — основной Streamlit‑приложение (в том числе для деплоя, например, в Streamlit Cloud). Содержит весь UI, предобработку признаков и логику инференса модели.
- `requirements.txt` — список Python‑зависимостей, необходимых для запуска приложения.
- `beginner.ipynb` — блокнот для экспериментов/обучения модели (не используется напрямую при работе приложения).

Ожидаемые вспомогательные данные и артефакты (должны находиться рядом с приложением):
- `penguins.csv` — датасет, используемый для построения гистограмм и распределений признаков.
- `random_forest_penguin.pickle` — сериализованный классификатор Random Forest.
- `output_penguin.pickle` — отображение индексов выходов модели в имена видов.
- `feature_importance.png` — статичное изображение важности признаков, отображаемое в UI.

## Архитектура и структура кода

Приложение реализовано в виде одного файла Streamlit со следующей общей структурой:

1. **Импорты и глобальная инициализация**
   - Используются библиотеки `streamlit`, `seaborn`, `matplotlib.pyplot`, `pandas` и стандартный модуль `pickle`.
   - При импорте модуля загружаются датасет и артефакты модели:
     - `penguin_df = pd.read_csv('penguins.csv')`
     - `rfc = pickle.load(open('random_forest_penguin.pickle', 'rb'))`
     - `unique_penguin_mapping = pickle.load(open('output_penguin.pickle', 'rb'))`

2. **Контроль доступа по паролю**
   - В начале скрипта приложение запрашивает у пользователя пароль и сравнивает его со значением из `st.secrets`:
     - `password_guess = st.text_input("Введите пароль")`
     - `if password_guess != st.secrets["passwordcd"]: st.stop()`
   - Для этого при запуске в защищённой среде требуется файл `.streamlit/secrets.toml` (или эквивалентная конфигурация) с ключом `passwordcd`.

3. **Форма ввода признаков**
   - Одна форма `st.form` с именем `"пользовательские вводы"` собирает следующие признаки:
     - Остров (`island`) — одно из значений: `"Biscoe"`, `"Dream"`, `"Torgerson"`.
     - Пол (`sex`) — `"Женская особь"` или `"Мужская особь"`.
     - Числовые признаки: `bill_length`, `bill_depth`, `flipper_length`, `body_mass` (все через `st.number_input` с `min_value=0`).
   - Форма имеет кнопку отправки; после отправки выбранные значения остаются в состоянии Streamlit и используются далее для инференса и визуализации.

4. **Кодирование признаков**
   - После формы скрипт вручную кодирует категориальные признаки в one‑hot‑переменные:
     - Острова → `island_biscoe`, `island_dream`, `island_torgerson`.
     - Пол → `sex_female`, `sex_male`.
   - Эти признаки вместе с четырьмя числовыми собираются в вектор фиксированного порядка, соответствующий схеме признаков при обучении:
     - `[bill_length, bill_depth, flipper_length, body_mass,
        island_biscoe, island_dream, island_torgerson,
        sex_female, sex_male]`.

5. **Инференс модели и преобразование результата**
   - Для предсказания используется классификатор Random Forest `rfc`:
     - `new_prediction = rfc.predict([[...features...]])`
   - Индекс предсказания преобразуется в человеко‑читаемое название вида с помощью `unique_penguin_mapping`:
     - `prediction_species = unique_penguin_mapping[new_prediction][0]`.

6. **Отображение результатов и объяснения**
   - Выводится предсказанный вид пингвина и текстовое объяснение о модели и важности признаков.
   - Отображается статичное изображение `feature_importance.png`.
   - Строятся три гистограммы `seaborn.displot` для ключевых признаков (`длина_клюва_мм`, `высота_клюва_мм`, `длина_ласт_мм`) с вертикальными линиями (`plt.axvline(...)`) на введённых пользователем значениях; фигуры передаются в `st.pyplot`.

### Архитектурные особенности

- Приложение **почти не имеет состояния** и сильно опирается на глобальную инициализацию при импорте модуля для загрузки модели и данных. Если в будущем появятся несколько страниц или более сложные сценарии, стоит вынести логику в функции (например, `load_model()`, `prepare_features()`, `predict_species()`), но в текущем виде однофайловая структура проста и прозрачна.
- Кодирование категориальных признаков и порядок признаков **жёстко захардкожены**. При переобучении модели или изменении признаков необходимо поддерживать тот же порядок (или синхронно обновлять и этот скрипт, и код обучения).
- Проверка пароля выполняется на верхнем уровне; при неверном пароле вызывается `st.stop()`, и дальнейший код не исполняется.

## Среда разработки и зависимости

Зависимости Python указаны в `requirements.txt`:
- `matplotlib`
- `pandas`
- `scikit-learn==1.1.3`
- `seaborn`
- `streamlit`
- `pickle` (модуль стандартной библиотеки; обычно его не обязательно указывать в `requirements.txt`).

Рекомендуемая последовательность настройки окружения:
1. Создать и активировать виртуальное окружение Python (например, через `venv` или `conda`).
2. Установить зависимости:
   - `pip install -r requirements.txt`

## Основные команды

Все команды ниже предполагается выполнять из корня репозитория.

### Запуск Streamlit‑приложения локально

Основное приложение (защищено паролем, использует `penguins_streamlit_cloud.py`):
- `streamlit run penguins_streamlit_cloud.py`

При необходимости можно экспериментировать или сравнивать другой входной скрипт (если будет реализован позже):
- `streamlit run penguins_steamlit.py`

### Линтинг и форматирование

В репозитории нет настроенного линтера. Если будете добавлять линтинг, можно использовать:
- `ruff .` — быстрый линтер для Python.
- `black .` — автоформатирование кода.

Эти инструменты пока не перечислены в `requirements.txt`, поэтому их при необходимости нужно установить отдельно.

### Тестирование

Сейчас в репозитории нет настроенного тестового фреймворка и тестов. Если добавите тесты:
- Размещайте их в директории `tests/` и используйте `pytest`.
- Типичные команды (после появления тестов):
  - `pytest` — запуск всех тестов.
  - `pytest -k подстрока_имени` — запуск части тестов по маске имени.

## Ожидаемые данные и секреты

Для успешного запуска приложения (особенно вне Streamlit Cloud) в рабочем каталоге должны быть доступны следующие файлы и конфигурация:

- `penguins.csv` — датасет с как минимум следующими столбцами:
  - `длина_клюва_мм`
  - `высота_клюва_мм`
  - `длина_ласт_мм`
  - `вид`
- `random_forest_penguin.pickle` — обученный `sklearn.ensemble.RandomForestClassifier`, совместимый с 9‑мерным вектором признаков.
- `output_penguin.pickle` — отображение индекса предсказания в название вида.
- `feature_importance.png` — изображение с важностью признаков, используемое в интерфейсе.

Для защиты паролем при использовании `st.secrets` необходимо:
- Создать `.streamlit/secrets.toml` с ключом `passwordcd`, содержащим желаемый пароль.

Будущим агентам имеет смысл проверять наличие этих файлов перед изменениями или запуском приложения и следить за тем, чтобы порядок признаков оставался согласованным между кодом обучения и инференсом.
